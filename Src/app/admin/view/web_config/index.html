<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>系统设置 - Powered by __CAOZHA-SYS-NAME__ __CAOZHA-SYS-VERSION__</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="__CAOZHA-LAYUIMINI__/lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="__CAOZHA-LAYUIMINI__/css/public.css" media="all">
    <style>
        .layui-form-item .layui-input-company {width: auto;padding-right: 10px;line-height: 38px;}
    </style>
    <script src="__CAOZHA-STATIC__/js/jquery-3.4.1.min.js"></script>
    <script src="__CAOZHA-LAYUIMINI__/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
    <script src="__CAOZHA-STATIC__/js/all.js"></script>
    <link rel="stylesheet" href="__CAOZHA-STATIC__/css/style.css" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">

        <div class="layui-form layuimini-form web-config-form">

            <div class="layui-form-item">
                <label class="layui-form-label required">对外调用域名</label>
                <div class="layui-input-block">
                    <input type="text" name="share_url" lay-verify="required" lay-reqtext="网址不能为空" placeholder="请输入网址"  value="{$web_config.share_url}" class="layui-input">
                    <tip>格式：http://caozha.com</tip>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">管理员每页显示</label>
                <div class="layui-input-block"><!--此处设置的选项必须跟管理员页面设置的limits一致，否则出错-->
                    <select name="admin_limit" id="admin_limit">
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                        <option value="15">15条</option>
                        <option value="20">20条</option>
                        <option value="25">25条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">管理员权限组每页显示</label>
                <div class="layui-input-block"><!--此处设置的选项必须跟权限组页面设置的limits一致，否则出错-->
                    <select name="roles_limit">
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                        <option value="15">15条</option>
                        <option value="20">20条</option>
                        <option value="25">25条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">系统日志每页显示</label>
                <div class="layui-input-block"><!--此处设置的选项必须跟系统日志页面设置的limits一致，否则出错-->
                    <select name="syslog_limit">
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                        <option value="15">15条</option>
                        <option value="20">20条</option>
                        <option value="25">25条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">订单管理每页显示</label>
                <div class="layui-input-block"><!--此处设置的选项必须跟文章管理页面设置的limits一致，否则出错-->
                    <select name="order_limit">
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                        <option value="15">15条</option>
                        <option value="20">20条</option>
                        <option value="25">25条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">产品管理每页显示</label>
                <div class="layui-input-block"><!--此处设置的选项必须跟文章管理页面设置的limits一致，否则出错-->
                    <select name="product_limit">
                        <option value="5">5条</option>
                        <option value="10">10条</option>
                        <option value="15">15条</option>
                        <option value="20">20条</option>
                        <option value="25">25条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                        <option value="200">200条</option>
                        <option value="500">500条</option>
                        <option value="1000">1000条</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">上传订单大小限制</label>
                <div class="layui-input-block">
                    <input type="text" name="order_upload_limit" lay-verify="required" lay-reqtext="上传订单限制不能为空，且必须为数字" placeholder="请输入数字"  value="{$web_config.order_upload_limit}" class="layui-input">
                    <tip>单位：M，建议设置20，即限制20M以内的文件上传。</tip>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">导入订单时最大内存</label>
                <div class="layui-input-block">
                    <input type="text" name="order_upload_memory_limit" lay-verify="required" lay-reqtext="导入订单时最大内存的设置不能为空，且必须为数字" placeholder="请输入数字"  value="{$web_config.order_upload_memory_limit}" class="layui-input">
                    <tip>设置处理导入订单时允许使用的最大内存，单位M。建议设置1000以内，具体看服务器自身配置。</tip>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">订单查重时每次处理量</label>
                <div class="layui-input-block">
                    <input type="text" name="order_repeat_check_limit" lay-verify="required" lay-reqtext="检测重复订单每次处理量不能为空，且必须为数字" placeholder="请输入数字"  value="{$web_config.order_repeat_check_limit}" class="layui-input">
                    <tip>建议设置500，即检测重复订单时每次处理500个。</tip>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">检测重复订单的字段</label>
                <div class="layui-input-block">
                    <table class="layui-hide" id="order_repeat_check_fields" lay-filter="order_repeat_check_fields_filter"></table>
                    <tip style="line-height: 180%;"><span style="color: red;font-weight: bold;">【注意事项】</span><br>1、检测重复订单时，将以上面设置的字段作为判断是否重复的依据，即：以上字段的数据完全一样时判定为重复。<br>2、一旦设置后不建议随意更改，如确实需要更改，请先：<a href="{:url('admin/web_config/order_reset')}" style="color:red;">重置订单重复数据</a>。原因是：重新设置后只对后来的订单有影响，对之前已设置成重复订单的数据无影响。<br>&nbsp; </tip>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn caozha-submit" lay-submit="" lay-filter="setting">确认保存</button>
                    <button type="reset" class="layui-btn layui-btn-primary caozha-reset">重置</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['form','table'], function () {
        var form = layui.form
            ,layer = layui.layer;

        var table = layui.table;
        table.render({
            elem: '#order_repeat_check_fields'
            ,url:'{:url(\'admin/web_config/getFields\')}'
            ,parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": "0", //解析接口状态 res.status
                    "msg": "", //解析提示文本 res.message
                    "count": "", //解析数据长度
                    "data": res //解析数据列表
                };
            }
            ,title: '字段表'
            //,totalRow: true
            ,even: false  //隔行背景
            ,size: ""//sm （小尺寸）       lg （大尺寸）
            ,cols: [[
                {type: "checkbox", width: 40, align: "center"}
                ,{field:'field', title:'字段名',width:150, minWidth:150}
                ,{field:'comment', title:'描述'}
            ]]
            ,page: false
        });


        layer_skin(layer);

        $('select[name="admin_limit"]').val('{$web_config.admin_limit}');
        $('select[name="roles_limit"]').val('{$web_config.roles_limit}');
        $('select[name="syslog_limit"]').val('{$web_config.syslog_limit}');
        $('select[name="order_limit"]').val('{$web_config.order_limit}');
        $('select[name="product_limit"]').val('{$web_config.product_limit}');
        form.render('select'); //刷新select选择框渲染

        //监听提交
        form.on('submit(setting)', function (data) {

            var checkStatus = table.checkStatus('order_repeat_check_fields')
                , fields_data = checkStatus.data;
            var key_arr = $.map(fields_data, function (d) {
                return d.field;
            });
            //layer.alert(JSON.stringify(key_arr));
            var key_str = key_arr.join(",");//转为字符串

            if (key_str == "") {
                layer.msg('请选择作为检测重复订单依据的字段。', {icon: 2});
                return false;
            }

            post_data=data.field;
            post_data["order_repeat_check_fields"]=key_str;

            $.ajax({
                type: "post",
                url: '{:url(\'admin/web_config/save\')}',
                data: post_data,
                dataType: "json",
                async: false,
                success: function (res) {
                    if (res.code == 1) {

                        caozha_success=layer.alert(res.msg, {
                            title:'成功提示',
                            btn: ['确定'],
                            closeBtn: 0,
                            btnAlign: 'c',
                            icon: 6,
                        }, function(){
                            window.location.reload();
                            });

                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                },
                complete: function (res) {
                }
            });
            return false;
        });

    });
</script>
</body>
</html>